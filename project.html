<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JnanaDesigns — Project</title>
  <meta name="description" content="Project details — JnanaDesigns">
  <!-- Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600&family=Playfair+Display:ital,wght@0,400;0,500;1,500&display=swap">
  <!-- marked + DOMPurify for robust Markdown rendering + sanitization -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

  <style>
    :root{
      --maxw:980px;
      --muted:#586066;
      --accent:#0B6E6E;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    html,body{height:100%}
    body{margin:0;background:#fff;color:#111;-webkit-font-smoothing:antialiased}
    .wrap{max-width:var(--maxw);margin:28px auto;padding:0 18px}
    .back{display:inline-flex;align-items:center;gap:10px;margin-bottom:18px;padding:8px 12px;border-radius:8px;border:1px solid #eee;background:#fafafa;text-decoration:none;color:inherit;font-size:14px}
    .brand-row{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:10px}
    /* Brand heading */
    #brand {
      margin:0;
      font-size:30px;
      display:flex;
      align-items:baseline;
      gap:6px;
    }
    .jnana {
      font-family:"Poppins",sans-serif;
      font-weight:600;
      color:#1f2a2a;
      font-size:30px;
      line-height:1;
    }
    .designs {
      font-family:"Playfair Display",serif;
      font-weight:500;
      font-style:italic;
      color:#2f2b2b;
      font-size:30px;
      line-height:1;
    }

    .meta{color:var(--muted);margin:10px 0 18px;font-size:14px}

    .content{
      background:#fff;
      padding:18px;
      border-radius:10px;
      border:1px solid #f0f0f0;
      color:#222;
    }
    .content p{line-height:1.6;margin:0 0 12px}
    .content img{max-width:100%;height:auto;border-radius:8px;display:block;margin:12px 0;cursor:zoom-in}
    .content pre{background:#f7f7f7;padding:12px;border-radius:8px;overflow:auto}
    .content a{color:var(--accent)}

    /* lightbox */
    #lightbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.78);align-items:center;justify-content:center;padding:18px;z-index:9999}
    #lightbox img{max-width:calc(100% - 40px);max-height:90vh;border-radius:8px;box-shadow:0 20px 50px rgba(0,0,0,0.6)}
    #lightbox .caption{color:#fff;margin-top:10px;font-family:'Playfair Display',serif;text-align:center}

    @media (max-width:640px){
      #brand{font-size:22px}
      .jnana{font-size:22px}
      .designs{font-size:22px}
      .wrap{margin:16px auto;padding:0 12px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <a class="back" href="./" aria-label="Back to portfolio">← Back</a>

    <div class="brand-row">
      <h1 id="brand" aria-hidden="true">
        <span class="jnana">Jnana</span><span class="designs">Designs</span>
      </h1>
      <!-- optional area: could add small actions e.g. download PDF for this project -->
    </div>

    <div id="meta" class="meta">Loading...</div>

    <div id="content" class="content" aria-live="polite">Loading project…</div>
  </div>

  <!-- lightbox -->
  <div id="lightbox" role="dialog" aria-hidden="true">
    <div style="text-align:center">
      <img id="lb-img" src="" alt="">
      <div id="lb-caption" class="caption"></div>
    </div>
  </div>

<script>
/* Utility: read query param ?issue=NNN */
function getQueryParam(name){
  const params = new URLSearchParams(location.search);
  return params.get(name);
}

/* Transform GitHub issue body into safe HTML:
   - Use marked.js to render markdown
   - sanitize with DOMPurify
   - ensure HTML <img> tags and plain image URLs are respected
*/
function renderBodyToHtml(md){
  if(!md) return '';

  // Some issue bodies might contain raw HTML <img> tags or github attachment tags.
  // We'll first convert raw HTML image tags into markdown image tokens so marked renders them.
  // Example: <img src="https://..."> -> ![](https://...)
  let body = md;

  // Convert HTML <img ... src="..."> to markdown image token so marked will produce an <img>
  body = body.replace(/<img[^>]+src=(?:'|")([^'"]+)(?:'|")[^>]*>/gi, function(_, src){
    return `![](${src})`;
  });

  // Convert plain image URLs (ending with image extension) on their own line into markdown images
  body = body.replace(/(^|\n)(https?:\/\/\S+\.(?:png|jpe?g|gif|webp|svg))(\s|$)/gi, '\n![]($2)\n');

  // Render markdown to HTML using marked
  const rendered = marked.parse(body);

  // Sanitize the HTML
  const clean = DOMPurify.sanitize(rendered, {
    ALLOWED_TAGS: ['a','p','img','strong','em','ul','ol','li','pre','code','blockquote','h1','h2','h3','br'],
    ALLOWED_ATTR: ['href','src','alt','title','target','rel']
  });

  return clean;
}

/* Lightbox handlers */
const lb = document.getElementById('lightbox');
const lbImg = document.getElementById('lb-img');
const lbCaption = document.getElementById('lb-caption');

function openLightbox(src, caption){
  lbImg.src = src;
  lbImg.alt = caption || '';
  lbCaption.textContent = caption || '';
  lb.style.display = 'flex';
  lb.setAttribute('aria-hidden','false');
  // focus for keyboard interaction
  lb.focus();
}

function closeLightbox(){
  lb.style.display = 'none';
  lb.setAttribute('aria-hidden','true');
  lbImg.src = '';
  lbCaption.textContent = '';
}

lb.addEventListener('click', (e)=>{
  // clicking outside the image closes
  if(e.target === lb || e.target === lbImg) closeLightbox();
});

document.addEventListener('keydown', (e)=>{
  if(lb.style.display === 'flex' && e.key === 'Escape') closeLightbox();
});

/* Render issue onto the page */
function showIssue(issue){
  document.getElementById('meta').textContent = `Published: ${new Date(issue.created_at).toLocaleDateString()}${(issue.labels||[]).length ? ' • Tags: ' + issue.labels.map(l=>l.name).join(', ') : ''}`;

  const html = renderBodyToHtml(issue.body || '');
  document.getElementById('content').innerHTML = html || '<p>(No description)</p>';

  // Attach click handlers to images inside content for lightbox
  document.querySelectorAll('#content img').forEach(img => {
    img.style.cursor = 'zoom-in';
    img.addEventListener('click', (ev) => {
      ev.stopPropagation();
      const captionText = (img.alt && img.alt !== '') ? img.alt : (img.title || '');
      openLightbox(img.src, captionText);
    });
  });
}

/* Fetch issue data and show */
async function loadIssue(){
  const issueNum = getQueryParam('issue');
  if(!issueNum){
    document.getElementById('content').innerHTML = '<p>No issue specified.</p>';
    document.getElementById('meta').textContent = '';
    return;
  }
  const owner = 'apoorvaj192';
  const repo = 'jnanadesigns';
  const url = `https://api.github.com/repos/${owner}/${repo}/issues/${issueNum}`;

  try {
    const res = await fetch(url);
    if(!res.ok) throw new Error('Failed to fetch issue: ' + res.status);
    const issue = await res.json();
    // Put a branded title at top (keeps consistent - we already show brand in header)
    document.title = `JnanaDesigns — ${issue.title || 'Project'}`;
    showIssue(issue);
  } catch(err){
    console.error(err);
    document.getElementById('content').innerHTML = '<p style="color:#c33">Unable to load project. Check console for details.</p>';
    document.getElementById('meta').textContent = '';
  }
}

/* Initialize */
loadIssue();
</script>
</body>
</html>
